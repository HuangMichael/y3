var DisPatchFormWizard = function () {
    return {
        init: function () {
            if (!jQuery().bootstrapWizard) {
                return;
            }
            var wizform = $('#dispatchForm');

            var selectCarts = "";
            var alert_success = $('.alert-success', wizform);
            var alert_error = $('.alert-danger', wizform);
            $('#formWizard').bootstrapWizard({
                'nextSelector': '.nextBtn',
                'previousSelector': '.prevBtn',
                onNext: function (tab, navigation, index) {
                    var total = navigation.find('li').length;
                    var current = index + 1;
                    if (current == 1) {
                        alert("验证选中记录");
                    } else if (current == 2) {
                        if (!validateSelect()) {
                            showMessageBoxCenter("danger", "center", "请选择维修信息！");
                            return false;
                        } else {
                            selectCarts = getSelectID().join(",");
                            LoadOrderDescList(selectCarts);
                        }
                        $('#formWizard').find('.prevBtn').show();
                        $('#formWizard').find('.nextBtn').show();
                        $('#formWizard').find('.submitBtn').hide();
                    } else if (current == 3) {
                        if (!checkOrderDesc()) {
                            showMessageBoxCenter("danger", "center", "请选择维修单位！");
                            return false;
                        } else {
                            //将描述更新到列表中
                            loadCommitPage(selectCarts);
                            //载入这两条信息
                        }
                        $('#formWizard').find('.prevBtn').show();
                        $('#formWizard').find('.nextBtn').hide();
                        $('#formWizard').find('.submitBtn').show();
                    }


                    $('.stepHeader', $('#formWizard')).text('第 ' + (index + 1) + ' 步共 ' + total + "步");
                    jQuery('li', $('#formWizard')).removeClass("done");
                    var li_list = navigation.find('li');
                    for (var i = 0; i < index; i++) {
                        jQuery(li_list[i]).addClass("done");
                    }
                },
                onPrevious: function (tab, navigation, index) {
                    alert_success.hide();
                    alert_error.hide();
                    var total = navigation.find('li').length;
                    var current = index + 1;
                    $('.stepHeader', $('#formWizard')).text('第 ' + (index + 1) + ' 步共 ' + total + "步");
                    jQuery('li', $('#formWizard')).removeClass("done");
                    var li_list = navigation.find('li');
                    for (var i = 0; i < index; i++) {
                        jQuery(li_list[i]).addClass("done");
                    }

                    if (current == 1) {
                        $('#formWizard').find('.prevBtn').hide();
                        $('#formWizard').find('.nextBtn').show();
                        $('#formWizard').find('.submitBtn').hide();
                    }
                    else if (current == 2) {
                        $('#formWizard').find('.prevBtn').show();
                        $('#formWizard').find('.nextBtn').show();
                        $('#formWizard').find('.submitBtn').hide();
                    } else if (current == 3) {
                        $('#formWizard').find('.prevBtn').show();
                        $('#formWizard').find('.nextBtn').hide();
                        $('#formWizard').find('.submitBtn').show();
                    }


                },
                onTabClick: function (tab, navigation, index) {
                    return false;
                },
                onTabShow: function (tab, navigation, index) {
                    var total = navigation.find('li').length;
                    var current = index + 1;
                    var $percent = (current / total) * 100;
                    $('#formWizard').find('.progress-bar').css({
                        width: $percent + '%'
                    });
                }
            });

            $('#formWizard').find('.prevBtn').hide();
            $('#formWizard .submitBtn').click(function () {
                //根据维修单位生成维修单
                generateReportByUnit(selectCarts);


            }).hide();
        }
    };
}();


function getSelectID() {
    var chk_value = [];
    $('input[name^="cartCheck"]:checked').each(function () {

        if ($(this).val()) {
            chk_value.push($(this).val());
        }

    });
    return chk_value;
}


function validateSelect() {

    return getSelectID().length != 0;
}


function checkOrderDesc() {
    var result = true;
    $('input[id^="selUnit"]').each(function () {
        if (!$(this).val()) {
            result = false;
            return result;
        }
    });
    return result;
}


function getAllCheckboxID() {
    var chk_value = [];
    $('input[name^="cartCheck"]').each(function () {
        chk_value.push($(this).val());
    });
    return chk_value
}
/**
 *
 * @param ids
 * @constructor
 */
function LoadOrderDescList(ids) {
    var url = "/workOrderDispatch/loadOrderDesc";
    $("#payment").load(url, {ids, ids});

}


/**
 *  获取用户选择的维修单位
 */
function getAllSelected() {
    var array = [];
    $("input[id^='selUnit']").each(function () {
        var eId = $(this).attr("name");
        var id = eId.substr(7, eId.length);
        var unitId = $(this).val();
        array.push(unitId);
    });
}
/**
 *
 * @param ids
 * @constructor
 */
function loadCommitPage(ids) {
    var array = ids.split(",");
    var units = [];
    for (var x in array) {
        if (!isNaN(array[x])) {
            units.push($("#selUnit" + array[x]).val());
        }
    }

    $.ajaxSettings.async = false;
    var url = "/workOrderDispatch/loadCommitPage";
    $("#confirm").load(url, {ids: ids});
}

/*根据维修单位生成维修单*/
function generateReportByUnit(ids) {
    var url = "/workOrderReport/mapByUnitId";
    $.post(url, {ids: ids}, function (data) {
        showMessageBox("info", "维修单已生成！");
        $('#formWizard').find('.prevBtn').hide();
        $('#formWizard').find('.nextBtn').hide();
        $('#formWizard').find('.submitBtn').hide();
        //显示报修单已经提交成功
        var x = '<div align="center"><img src="/img/success.png" height="40px" width="40px"><h2 style="font-size:large;color:green;align-content: center">维修单提交成功!</h2></div>';
        $("#confirm").empty().append(x);
    });

}